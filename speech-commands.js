/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@tensorflow/tfjs")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs"],t):t(e.speechCommands={},e.tf)}(this,function(e,t){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function n(e,t,r,n){return new(r||(r=Promise))(function(a,s){function i(e){try{l(n.next(e))}catch(e){s(e)}}function o(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?a(e.value):new r(function(t){t(e.value)}).then(i,o)}l((n=n.apply(e,t||[])).next())})}function a(e,t){var r,n,a,s,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(s){return function(o){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,o])}}}function s(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function i(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,s=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(a)throw a.error}}return i}function o(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(i(arguments[t]));return e}var l=null;function u(e){return null==l&&(l=t.ENV.get("EPSILON")),t.tidy(function(){var r=t.moments(e),n=r.mean,a=r.variance;return e.sub(n).div(a.sqrt().add(l))})}var c=function(){function e(e){if(null==e)throw new Error("Required configuration object is missing for BrowserFftFeatureExtractor constructor");if(null==e.spectrogramCallback)throw new Error("spectrogramCallback cannot be null or undefined");if(!(e.numFramesPerSpectrogram>0))throw new Error("Invalid value in numFramesPerSpectrogram: "+e.numFramesPerSpectrogram);if(e.suppressionTimeMillis<0)throw new Error("Expected suppressionTimeMillis to be >= 0, but got "+e.suppressionTimeMillis);if(this.suppressionTimeMillis=e.suppressionTimeMillis,this.spectrogramCallback=e.spectrogramCallback,this.numFrames=e.numFramesPerSpectrogram,this.sampleRateHz=e.sampleRateHz||44100,this.fftSize=e.fftSize||1024,this.frameDurationMillis=this.fftSize/this.sampleRateHz*1e3,this.columnTruncateLength=e.columnTruncateLength||this.fftSize,this.overlapFactor=e.overlapFactor,t.util.assert(this.overlapFactor>=0&&this.overlapFactor<1,"Expected overlapFactor to be >= 0 and < 1, but got "+this.overlapFactor),this.columnTruncateLength>this.fftSize)throw new Error("columnTruncateLength "+this.columnTruncateLength+" exceeds fftSize ("+this.fftSize+").");this.audioContextConstructor=window.AudioContext||window.webkitAudioContext}return e.prototype.start=function(){return n(this,void 0,void 0,function(){var e,t,r;return a(this,function(s){switch(s.label){case 0:if(null!=this.frameIntervalTask)throw new Error("Cannot start already-started BrowserFftFeatureExtractor");return e=this,[4,function(){return n(this,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return[4,navigator.mediaDevices.getUserMedia({audio:!0,video:!1})];case 1:return[2,e.sent()]}})})}()];case 1:return e.stream=s.sent(),this.audioContext=new this.audioContextConstructor,this.audioContext.sampleRate!==this.sampleRateHz&&console.warn("Mismatch in sampling rate: Expected: "+this.sampleRateHz+"; Actual: "+this.audioContext.sampleRate),t=this.audioContext.createMediaStreamSource(this.stream),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2*this.fftSize,this.analyser.smoothingTimeConstant=0,t.connect(this.analyser),this.freqDataQueue=[],this.freqData=new Float32Array(this.fftSize),r=Math.max(1,Math.round(this.numFrames*(1-this.overlapFactor))),this.tracker=new h(r,Math.round(this.suppressionTimeMillis/this.frameDurationMillis)),this.frameIntervalTask=setInterval(this.onAudioFrame.bind(this),this.fftSize/this.sampleRateHz*1e3),[2]}})})},e.prototype.onAudioFrame=function(){return n(this,void 0,void 0,function(){var e,r;return a(this,function(n){switch(n.label){case 0:return this.analyser.getFloatFrequencyData(this.freqData),this.freqData[0]===-1/0?[2]:(this.freqDataQueue.push(this.freqData.slice(0,this.columnTruncateLength)),this.freqDataQueue.length>this.numFrames&&this.freqDataQueue.shift(),this.tracker.tick()?(e=function(e){var t=e[0].length,r=new Float32Array(e.length*t);return e.forEach(function(e,n){return r.set(e,n*t)}),r}(this.freqDataQueue),r=function(e,r){var n=new Float32Array(t.util.sizeFromShape(r));return n.set(e,n.length-e.length),t.tensor(n,r)}(e,[1,this.numFrames,this.columnTruncateLength,1]),[4,this.spectrogramCallback(r)]):[3,2]);case 1:n.sent()&&this.tracker.suppress(),r.dispose(),n.label=2;case 2:return[2]}})})},e.prototype.stop=function(){return n(this,void 0,void 0,function(){return a(this,function(e){if(null==this.frameIntervalTask)throw new Error("Cannot stop because there is no ongoing streaming activity.");return clearInterval(this.frameIntervalTask),this.frameIntervalTask=null,this.analyser.disconnect(),this.audioContext.close(),null!=this.stream&&this.stream.getTracks().length>0&&this.stream.getTracks()[0].stop(),[2]})})},e.prototype.setConfig=function(e){throw new Error("setConfig() is not implemented for BrowserFftFeatureExtractor.")},e.prototype.getFeatures=function(){throw new Error("getFeatures() is not implemented for BrowserFftFeatureExtractor. Use the spectrogramCallback field of the constructor config instead.")},e}();var h=function(){function e(e,r){this.period=e,this.suppressionTime=null==r?0:r,this.counter=0,t.util.assert(this.period>0,"Expected period to be positive, but got "+this.period)}return e.prototype.tick=function(){return this.counter++,this.counter%this.period==0&&(null==this.suppressionOnset||this.counter-this.suppressionOnset>this.suppressionTime)},e.prototype.suppress=function(){this.suppressionOnset=this.counter},e}();function d(e){var t=0;e.forEach(function(e){t+=e.byteLength});var r=new Uint8Array(t),n=0;return e.forEach(function(e){r.set(new Uint8Array(e),n),n+=e.byteLength}),r.buffer}function p(e){if(null==e)throw new Error("Received null or undefind string");for(var t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length),n=0;n<t.length;++n)r[n]=t.charCodeAt(n);return r.buffer}function f(e){if(null==e)throw new Error("Received null or undefind buffer");var t=new Uint8Array(e);return decodeURIComponent(escape(String.fromCharCode.apply(String,o(t))))}var m="TFJSSCDS",g=1,v=function(){function e(e){if(this.examples={},this.label2Ids={},null!=e)for(var r=function(e){t.util.assert(null!=e,"Received null or undefined buffer");var r=0,n=f(e.slice(r,m.length));t.util.assert(n===m,"Deserialization error: Invalid descriptor"),r+=m.length,r+=4;var a=new Uint32Array(e,r,1),s=r+=4;r=s+a[0];var i=f(e.slice(s,r)),o=JSON.parse(i),l=e.slice(r);return{manifest:o,data:l}}(e),n=0,a=0;a<r.manifest.length;++a){var s=r.manifest[a],i=s.spectrogramNumFrames*s.spectrogramFrameSize;null!=s.rawAudioNumSamples&&(i+=s.rawAudioNumSamples),i*=4,this.addExample(y({spec:s,data:r.data.slice(n,n+i)})),n+=i}}return e.prototype.addExample=function(e){t.util.assert(null!=e,"Got null or undefined example"),t.util.assert(null!=e.label&&e.label.length>0,"Expected label to be a non-empty string, but got "+JSON.stringify(e.label));var r=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}();return this.examples[r]=e,e.label in this.label2Ids||(this.label2Ids[e.label]=[]),this.label2Ids[e.label].push(r),r},e.prototype.merge=function(e){var r,n,a,i;t.util.assert(e!==this,"Cannot merge a dataset into itself");var o=e.getVocabulary();try{for(var l=s(o),u=l.next();!u.done;u=l.next()){var c=u.value,h=e.getExamples(c);try{for(var d=s(h),p=d.next();!p.done;p=d.next()){var f=p.value;this.addExample(f.example)}}catch(e){a={error:e}}finally{try{p&&!p.done&&(i=d.return)&&i.call(d)}finally{if(a)throw a.error}}}}catch(e){r={error:e}}finally{try{u&&!u.done&&(n=l.return)&&n.call(l)}finally{if(r)throw r.error}}},e.prototype.getExampleCounts=function(){var e={};for(var t in this.examples){var r=this.examples[t];r.label in e||(e[r.label]=0),e[r.label]++}return e},e.prototype.getExamples=function(e){var r=this;t.util.assert(null!=e,"Expected label to be a string, but got "+JSON.stringify(e)),t.util.assert(e in this.label2Ids,'No example of label "'+e+'" exists in dataset');var n=[];return this.label2Ids[e].forEach(function(e){n.push({uid:e,example:r.examples[e]})}),n},e.prototype.getSpectrogramsAsTensors=function(e,r){var n=this;t.util.assert(this.size()>0,"Cannot get spectrograms as tensors because the dataset is empty");var a=this.getVocabulary();null!=e?t.util.assert(-1!==a.indexOf(e),"Label "+e+" is not in the vocabulary ("+JSON.stringify(a)+")"):t.util.assert(a.length>1,"One-hot encoding of labels requires the vocabulary to have at least two words, but it has only "+a.length+" word."),null==r&&(r={});var i,o,l=this.getSortedUniqueNumFrames();1===l.length?(i=null==r.numFrames?l[0]:r.numFrames,o=null==r.hopFrames?1:r.hopFrames):(i=r.numFrames,t.util.assert(null!=i&&Number.isInteger(i)&&i>0,"There are "+l.length+" unique lengths among the "+this.size()+" examples of this Dataset, hence numFrames is required. But it is not provided."),t.util.assert(i<=l[0],"numFrames ("+i+") exceeds the minimum numFrames ("+l[0]+") among the examples of the Dataset."),o=r.hopFrames,t.util.assert(null!=o&&Number.isInteger(o)&&o>0,"There are "+l.length+" unique lengths among the "+this.size()+" examples of this Dataset, hence hopFrames is required. But it is not provided."));var c=null==r.normalize||r.normalize;return t.tidy(function(){for(var l,h,d,p=[],f=[],m=0;m<a.length;++m){var g=a[m];if(null==e||g===e){var v=n.label2Ids[g],b=function(r){var a,l,h=n.examples[r].spectrogram,v=h.frameSize;null==d?d=v:t.util.assert(v===d,"Mismatch in frameSize  ("+v+" vs "+d+")");var b=h.data.length/v,y="_background_noise_"===g?null:S(h).dataSync()[0],x=t.tensor3d(h.data,[b,v,1]),E=w(b,y,i,o),T=function(r){var n=t.tidy(function(){var e=x.slice([r[0],0,0],[r[1]-r[0],-1,-1]);return c?u(e):e});p.push(n),null==e&&f.push(m)};try{for(var M=s(E),F=M.next();!F.done;F=M.next()){T(F.value)}}catch(e){a={error:e}}finally{try{F&&!F.done&&(l=M.return)&&l.call(M)}finally{if(a)throw a.error}}t.dispose(x)};try{for(var y=s(v),x=y.next();!x.done;x=y.next()){b(x.value)}}catch(e){l={error:e}}finally{try{x&&!x.done&&(h=y.return)&&h.call(y)}finally{if(l)throw l.error}}}}if(null==r.shuffle||r.shuffle){var E=[];p.forEach(function(e,t){E.push({x:e,y:f[t]})}),t.util.shuffle(E),p=E.map(function(e){return e.x}),f=E.map(function(e){return e.y})}return{xs:t.stack(p),ys:null==e?t.oneHot(t.tensor1d(f,"int32"),a.length).asType("float32"):void 0}})},e.prototype.getSortedUniqueNumFrames=function(){for(var e,t,r=new Set,n=this.getVocabulary(),a=0;a<n.length;++a){var i=n[a],l=this.label2Ids[i];try{for(var u=s(l),c=u.next();!c.done;c=u.next()){var h=c.value,d=this.examples[h].spectrogram,p=d.data.length/d.frameSize;r.add(p)}}catch(t){e={error:t}}finally{try{c&&!c.done&&(t=u.return)&&t.call(u)}finally{if(e)throw e.error}}}var f=o(r);return f.sort(),f},e.prototype.removeExample=function(e){if(!(e in this.examples))throw new Error("Nonexistent example UID: "+e);var t=this.examples[e].label;delete this.examples[e];var r=this.label2Ids[t].indexOf(e);this.label2Ids[t].splice(r,1),0===this.label2Ids[t].length&&delete this.label2Ids[t]},e.prototype.size=function(){return Object.keys(this.examples).length},e.prototype.empty=function(){return 0===this.size()},e.prototype.clear=function(){this.examples={}},e.prototype.getVocabulary=function(){var e=new Set;for(var t in this.examples){var r=this.examples[t];e.add(r.label)}var n=o(e);return n.sort(),n},e.prototype.serialize=function(){var e,r,n,a,i=this.getVocabulary();t.util.assert(!this.empty(),"Cannot serialize empty Dataset");var o,l,u,c,h,f=[],v=[];try{for(var y=s(i),w=y.next();!w.done;w=y.next()){var x=w.value,S=this.label2Ids[x];try{for(var E=s(S),T=E.next();!T.done;T=E.next()){var M=T.value,F=b(this.examples[M]);f.push(F.spec),v.push(F.data)}}catch(e){n={error:e}}finally{try{T&&!T.done&&(a=E.return)&&a.call(E)}finally{if(n)throw n.error}}}}catch(t){e={error:t}}finally{try{w&&!w.done&&(r=y.return)&&r.call(y)}finally{if(e)throw e.error}}return o={manifest:f,data:d(v)},l=p(JSON.stringify(o.manifest)),u=p(m),c=new Uint32Array([g]),h=new Uint32Array([l.byteLength]),d([d([u,c.buffer,h.buffer]),l,o.data])},e}();function b(e){var t=null!=e.rawAudio,r={label:e.label,spectrogramNumFrames:e.spectrogram.data.length/e.spectrogram.frameSize,spectrogramFrameSize:e.spectrogram.frameSize},n=e.spectrogram.data.buffer.slice(0);return t&&(r.rawAudioNumSamples=e.rawAudio.data.length,r.rawAudioSampleRateHz=e.rawAudio.sampleRateHz,n=d([n,e.rawAudio.data.buffer])),{spec:r,data:n}}function y(e){var t={frameSize:e.spec.spectrogramFrameSize,data:new Float32Array(e.data.slice(0,4*e.spec.spectrogramFrameSize*e.spec.spectrogramNumFrames))},r={label:e.spec.label,spectrogram:t};return null!=e.spec.rawAudioNumSamples&&(r.rawAudio={sampleRateHz:e.spec.rawAudioSampleRateHz,data:new Float32Array(e.data.slice(4*e.spec.spectrogramFrameSize*e.spec.spectrogramNumFrames))}),r}function w(e,r,n,a){if(t.util.assert(Number.isInteger(e)&&e>0,"snippetLength must be a positive integer, but got "+e),null!=r&&t.util.assert(Number.isInteger(r)&&r>=0,"focusIndex must be a non-negative integer, but got "+r),t.util.assert(Number.isInteger(n)&&n>0,"windowLength must be a positive integer, but got "+n),t.util.assert(Number.isInteger(a)&&a>0,"windowHop must be a positive integer, but got "+a),t.util.assert(n<=e,"windowLength ("+n+") exceeds snippetLength ("+e+")"),t.util.assert(r<e,"focusIndex ("+r+") equals or exceeds snippetLength ("+e+")"),n===e)return[[0,e]];var s=[];if(null==r){for(var i=0;i+n<=e;)s.push([i,i+n]),i+=a;return s}var o=r-Math.floor(n/2);for(o<0?o=0:o+n>e&&(o=e-n);!(o-a<0||r>=o-a+n);)o-=a;for(;o+n<=e&&!(r<o);)s.push([o,o+n]),o+=a;return s}function x(e){return t.tidy(function(){var r=e.data.length/e.frameSize;return t.tensor2d(e.data,[r,e.frameSize]).mean(-1)})}function S(e){return t.tidy(function(){return x(e).argMax()})}var E="0.2.3",T="tfjs-speech-commands-saved-model-metadata",M="indexeddb://tfjs-speech-commands-model/",F=!1,z={localStorage:"undefined"==typeof window?null:window.localStorage};var L=function(){function e(r,n,a){this.MODEL_URL_PREFIX="https://storage.googleapis.com/tfjs-models/tfjs/speech-commands/v"+E.split(".").slice(0,2).join(".")+"/browser_fft",this.SAMPLE_RATE_HZ=44100,this.FFT_SIZE=1024,this.DEFAULT_SUPPRESSION_TIME_MILLIS=0,this.transferRecognizers={},t.util.assert(null==n&&null==a||null!=n&&null!=a,"modelURL and metadataURL must be both provided or both not provided."),null==n?(null==r?r=e.DEFAULT_VOCABULARY_NAME:t.util.assert(-1!==e.VALID_VOCABULARY_NAMES.indexOf(r),"Invalid vocabulary name: '"+r+"'"),this.vocabulary=r,this.modelURL=this.MODEL_URL_PREFIX+"/"+this.vocabulary+"/model.json",this.metadataURL=this.MODEL_URL_PREFIX+"/"+this.vocabulary+"/metadata.json"):(t.util.assert(null==r,"vocabulary name must be null or undefined when modelURL is provided"),this.modelURL=n,this.metadataURL=a),this.parameters={sampleRateHz:this.SAMPLE_RATE_HZ,fftSize:this.FFT_SIZE}}return e.prototype.listen=function(e,r){return n(this,void 0,void 0,function(){var s,l,h,d,p,f=this;return a(this,function(m){switch(m.label){case 0:if(F)throw new Error("Cannot start streaming again when streaming is ongoing.");return[4,this.ensureModelLoaded()];case 1:if(m.sent(),null==r&&(r={}),s=null==r.probabilityThreshold?0:r.probabilityThreshold,r.includeEmbedding&&(s=0),t.util.assert(s>=0&&s<=1,"Invalid probabilityThreshold value: "+s),l=null!=r.invokeCallbackOnNoiseAndUnknown&&r.invokeCallbackOnNoiseAndUnknown,r.includeEmbedding&&(l=!0),r.suppressionTimeMillis<0)throw new Error("suppressionTimeMillis is expected to be >= 0, but got "+r.suppressionTimeMillis);return h=null==r.overlapFactor?.5:r.overlapFactor,t.util.assert(h>=0&&h<1,"Expected overlapFactor to be >= 0 and < 1, but got "+h),d=function(c){return n(f,void 0,void 0,function(){var n,h,d,p,f,m,g,v,b,y,w;return a(this,function(a){switch(a.label){case 0:return h=u(c),r.includeEmbedding?[4,this.ensureModelWithEmbeddingOutputCreated()]:[3,2];case 1:return a.sent(),n=i(this.modelWithEmbeddingOutput.predict(h),2),d=n[0],p=n[1],[3,3];case 2:d=this.model.predict(h),a.label=3;case 3:return[4,d.data()];case 4:return f=a.sent(),[4,(m=d.argMax(-1)).data()];case 5:return g=a.sent()[0],v=Math.max.apply(Math,o(f)),t.dispose([d,m,h]),v<s?[2,!1]:[3,6];case 6:return b=void 0,r.includeSpectrogram?(y={},[4,c.data()]):[3,8];case 7:y.data=a.sent(),y.frameSize=this.nonBatchInputShape[1],b=y,a.label=8;case 8:return w=!0,l||"_background_noise_"!==this.words[g]&&"_unknown_"!==this.words[g]||(w=!1),w&&e({scores:f,spectrogram:b,embedding:p}),[2,w]}})})},p=null==r.suppressionTimeMillis?this.DEFAULT_SUPPRESSION_TIME_MILLIS:r.suppressionTimeMillis,this.audioDataExtractor=new c({sampleRateHz:this.parameters.sampleRateHz,numFramesPerSpectrogram:this.nonBatchInputShape[0],columnTruncateLength:this.nonBatchInputShape[1],suppressionTimeMillis:p,spectrogramCallback:d,overlapFactor:h}),[4,this.audioDataExtractor.start()];case 2:return m.sent(),F=!0,[2]}})})},e.prototype.ensureModelLoaded=function(){return n(this,void 0,void 0,function(){var e,r,n,s,i=this;return a(this,function(a){switch(a.label){case 0:return null!=this.model?[2]:[4,this.ensureMetadataLoaded()];case 1:return a.sent(),[4,t.loadModel(this.modelURL)];case 2:if(1!==(e=a.sent()).inputs.length)throw new Error("Expected model to have 1 input, but got a model with "+e.inputs.length+" inputs");if(4!==e.inputs[0].shape.length)throw new Error("Expected model to have an input shape of rank 4, but got an input shape of rank "+e.inputs[0].shape.length);if(1!==e.inputs[0].shape[3])throw new Error("Expected model to have an input shape with 1 as the last dimension, but got input shape"+JSON.stringify(e.inputs[0].shape[3])+"}");if(2!==(r=e.outputShape).length)throw new Error("Expected loaded model to have an output shape of rank 2,but received shape "+JSON.stringify(r));if(r[1]!==this.words.length)throw new Error("Mismatch between the last dimension of model's output shape ("+r[1]+") and number of words ("+this.words.length+").");return this.model=e,this.freezeModel(),this.nonBatchInputShape=e.inputs[0].shape.slice(1),this.elementsPerExample=1,e.inputs[0].shape.slice(1).forEach(function(e){return i.elementsPerExample*=e}),this.warmUpModel(),n=this.parameters.fftSize/this.parameters.sampleRateHz*1e3,s=e.inputs[0].shape[1],this.parameters.spectrogramDurationMillis=s*n,[2]}})})},e.prototype.ensureModelWithEmbeddingOutputCreated=function(){return n(this,void 0,void 0,function(){var e,r;return a(this,function(n){switch(n.label){case 0:return null!=this.modelWithEmbeddingOutput?[2]:[4,this.ensureModelLoaded()];case 1:for(n.sent(),r=this.model.layers.length-2;r>=0;--r)if("Dense"===this.model.layers[r].getClassName()){e=this.model.layers[r];break}if(null==e)throw new Error("Failed to find second last dense layer in the original model.");return this.modelWithEmbeddingOutput=t.model({inputs:this.model.inputs,outputs:[this.model.outputs[0],e.output]}),[2]}})})},e.prototype.warmUpModel=function(){var e=this;t.tidy(function(){for(var r=t.zeros([1].concat(e.nonBatchInputShape)),n=0;n<3;++n)e.model.predict(r)})},e.prototype.ensureMetadataLoaded=function(){return n(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return null!=this.words?[2]:[4,function(e){return n(this,void 0,void 0,function(){var t,r,n,s;return a(this,function(a){switch(a.label){case 0:return t="http://",r="https://",n="file://",0!==e.indexOf(t)&&0!==e.indexOf(r)?[3,3]:[4,fetch(e)];case 1:return[4,a.sent().json()];case 2:return[2,a.sent()];case 3:if(0===e.indexOf(n))return s=require("fs"),[2,JSON.parse(s.readFileSync(e.slice(n.length),{encoding:"utf-8"}))];throw new Error("Unsupported URL scheme in metadata URL: "+e+". Supported schemes are: http://, https://, and (node.js-only) file://");case 4:return[2]}})})}(this.metadataURL)];case 1:return e=t.sent(),this.words=e.words,[2]}})})},e.prototype.stopListening=function(){return n(this,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:if(!F)throw new Error("Cannot stop streaming when streaming is not ongoing.");return[4,this.audioDataExtractor.stop()];case 1:return e.sent(),F=!1,[2]}})})},e.prototype.isListening=function(){return F},e.prototype.wordLabels=function(){return this.words},e.prototype.params=function(){return this.parameters},e.prototype.modelInputShape=function(){if(null==this.model)throw new Error("Model has not been loaded yet. Load model by calling ensureModelLoaded(), recognize(), or listen().");return this.model.inputs[0].shape},e.prototype.recognize=function(e,r){return n(this,void 0,void 0,function(){var n,s,i,o,l,u,c,h,d,p,f,m,g;return a(this,function(a){switch(a.label){case 0:return null==r&&(r={}),[4,this.ensureModelLoaded()];case 1:return a.sent(),null!=e?[3,3]:[4,this.recognizeOnline()];case 2:n=a.sent(),e=n.data,a.label=3;case 3:if(e instanceof t.Tensor)this.checkInputTensorShape(e),i=e,s=e.shape[0];else{if((e=e).length%this.elementsPerExample)throw new Error("The length of the input Float32Array "+e.length+" is not divisible by the number of tensor elements per per example expected by the model "+this.elementsPerExample+".");s=e.length/this.elementsPerExample,i=t.tensor4d(e,[s].concat(this.nonBatchInputShape))}return l={scores:null},r.includeEmbedding?[4,this.ensureModelWithEmbeddingOutputCreated()]:[3,5];case 4:return a.sent(),u=this.modelWithEmbeddingOutput.predict(i),o=u[0],l.embedding=u[1],[3,6];case 5:o=this.model.predict(i),a.label=6;case 6:return 1!==s?[3,8]:(c=l,[4,o.data()]);case 7:return c.scores=a.sent(),[3,10];case 8:return h=t.unstack(o),d=h.map(function(e){return e.data()}),p=l,[4,Promise.all(d)];case 9:p.scores=a.sent(),t.dispose(h),a.label=10;case 10:return r.includeSpectrogram?(f=l,m={},e instanceof t.Tensor?[4,e.data()]:[3,12]):[3,14];case 11:return g=a.sent(),[3,13];case 12:g=e,a.label=13;case 13:f.spectrogram=(m.data=g,m.frameSize=this.nonBatchInputShape[1],m),a.label=14;case 14:return[2,l]}})})},e.prototype.recognizeOnline=function(){return n(this,void 0,void 0,function(){var e=this;return a(this,function(t){return[2,new Promise(function(t,r){e.audioDataExtractor=new c({sampleRateHz:e.parameters.sampleRateHz,numFramesPerSpectrogram:e.nonBatchInputShape[0],columnTruncateLength:e.nonBatchInputShape[1],suppressionTimeMillis:0,spectrogramCallback:function(r){return n(e,void 0,void 0,function(){var e,n,s;return a(this,function(a){switch(a.label){case 0:return e=u(r),[4,this.audioDataExtractor.stop()];case 1:return a.sent(),n=t,s={},[4,e.data()];case 2:return n.apply(void 0,[(s.data=a.sent(),s.frameSize=this.nonBatchInputShape[1],s)]),e.dispose(),[2,!1]}})})},overlapFactor:0}),e.audioDataExtractor.start()})]})})},e.prototype.createTransfer=function(e){if(null==this.model)throw new Error("Model has not been loaded yet. Load model by calling ensureModelLoaded(), recognizer(), or listen().");t.util.assert(null!=e&&"string"==typeof e&&e.length>1,"Expected the name for a transfer-learning recognized to be a non-empty string, but got "+JSON.stringify(e)),t.util.assert(null==this.transferRecognizers[e],"There is already a transfer-learning model named '"+e+"'");var r=new I(e,this.parameters,this.model);return this.transferRecognizers[e]=r,r},e.prototype.freezeModel=function(){var e,t;try{for(var r=s(this.model.layers),n=r.next();!n.done;n=r.next()){n.value.trainable=!1}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}},e.prototype.checkInputTensorShape=function(e){var r=this.model.inputs[0].shape.length;if(e.shape.length!==r)throw new Error("Expected input Tensor to have rank "+r+", but got rank "+e.shape.length+" that differs ");var n=e.shape.slice(1),a=this.model.inputs[0].shape.slice(1);if(!t.util.arraysEqual(n,a))throw new Error("Expected input to have shape [null,"+a+"], but got shape [null,"+n+"]")},e.VALID_VOCABULARY_NAMES=["18w","directional4w"],e.DEFAULT_VOCABULARY_NAME="18w",e}(),I=function(e){function i(r,n,a){var s=e.call(this)||this;return s.name=r,s.parameters=n,s.baseModel=a,t.util.assert(null!=r&&"string"==typeof r&&r.length>0,"The name of a transfer model must be a non-empty string, but got "+JSON.stringify(r)),s.nonBatchInputShape=s.baseModel.inputs[0].shape.slice(1),s.words=null,s.dataset=new v,s}return function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(i,e),i.prototype.collectExample=function(e,r){return n(this,void 0,void 0,function(){var s,i,o=this;return a(this,function(l){if(t.util.assert(!F,"Cannot start collection of transfer-learning example because a streaming recognition or transfer-learning example collection is ongoing"),t.util.assert(null!=e&&"string"==typeof e&&e.length>0,"Must provide a non-empty string when collecting transfer-learning example"),null==r&&(r={}),null!=r.durationMultiplier&&null!=r.durationSec)throw new Error("durationMultiplier and durationSec are mutually exclusive, but are both specified.");return null!=r.durationSec?(t.util.assert(r.durationSec>0,"Expected durationSec to be > 0, but got "+r.durationSec),i=this.parameters.fftSize/this.parameters.sampleRateHz,s=Math.ceil(r.durationSec/i)):null!=r.durationMultiplier?(t.util.assert(r.durationMultiplier>=1,"Expected duration multiplier to be >= 1, but got "+r.durationMultiplier),s=Math.round(this.nonBatchInputShape[0]*r.durationMultiplier)):s=this.nonBatchInputShape[0],F=!0,[2,new Promise(function(t){o.audioDataExtractor=new c({sampleRateHz:o.parameters.sampleRateHz,numFramesPerSpectrogram:s,columnTruncateLength:o.nonBatchInputShape[1],suppressionTimeMillis:0,spectrogramCallback:function(r){return n(o,void 0,void 0,function(){var n,s,i,o,l,c,h;return a(this,function(a){switch(a.label){case 0:return n=u(r),i=(s=this.dataset).addExample,o={label:e},l={},[4,n.data()];case 1:return i.apply(s,[(o.spectrogram=(l.data=a.sent(),l.frameSize=this.nonBatchInputShape[1],l),o)]),n.dispose(),[4,this.audioDataExtractor.stop()];case 2:return a.sent(),F=!1,this.collateTransferWords(),c=t,h={},[4,r.data()];case 3:return c.apply(void 0,[(h.data=a.sent(),h.frameSize=this.nonBatchInputShape[1],h)]),[2,!1]}})})},overlapFactor:0}),o.audioDataExtractor.start()})]})})},i.prototype.clearExamples=function(){t.util.assert(null!=this.words&&this.words.length>0&&!this.dataset.empty(),"No transfer learning examples exist for model name "+this.name),this.dataset.clear(),this.words=null},i.prototype.countExamples=function(){if(this.dataset.empty())throw new Error("No examples have been collected for transfer-learning model named '"+this.name+"' yet.");return this.dataset.getExampleCounts()},i.prototype.getExamples=function(e){return this.dataset.getExamples(e)},i.prototype.removeExample=function(e){this.dataset.removeExample(e),this.collateTransferWords()},i.prototype.isDatasetEmpty=function(){return this.dataset.empty()},i.prototype.loadExamples=function(e,t){var r,n,a,i;void 0===t&&(t=!1);var o=new v(e);t&&this.clearExamples();var l=o.getVocabulary();try{for(var u=s(l),c=u.next();!c.done;c=u.next()){var h=c.value,d=o.getExamples(h);try{for(var p=s(d),f=p.next();!f.done;f=p.next()){var m=f.value;this.dataset.addExample(m.example)}}catch(e){a={error:e}}finally{try{f&&!f.done&&(i=p.return)&&i.call(p)}finally{if(a)throw a.error}}}}catch(e){r={error:e}}finally{try{c&&!c.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}this.collateTransferWords()},i.prototype.serializeExamples=function(){return this.dataset.serialize()},i.prototype.collateTransferWords=function(){this.words=this.dataset.getVocabulary()},i.prototype.collectTransferDataAsTensors=function(e,t){var r=this.nonBatchInputShape[0];t=t||.25;var n=Math.round(t*r),a=this.dataset.getSpectrogramsAsTensors(null,{numFrames:r,hopFrames:n});return{xs:a.xs,ys:a.ys}},i.prototype.train=function(e){return n(this,void 0,void 0,function(){var r,n,s,i,o,l,u,c,h,d,p,f;return a(this,function(a){switch(a.label){case 0:t.util.assert(null!=this.words&&this.words.length>0,"Cannot train transfer-learning model '"+this.name+"' because no transfer learning example has been collected."),t.util.assert(this.words.length>1,"Cannot train transfer-learning model '"+this.name+"' because only 1 word label ('"+JSON.stringify(this.words)+"') has been collected for transfer learning. Requires at least 2."),null!=e.fineTuningEpochs&&t.util.assert(e.fineTuningEpochs>=0&&Number.isInteger(e.fineTuningEpochs),"If specified, fineTuningEpochs must be a non-negative integer, but received "+e.fineTuningEpochs),null==e&&(e={}),null==this.model&&this.createTransferModelFromBaseModel(),this.secondLastBaseDenseLayer.trainable=!1,this.model.compile({loss:"categoricalCrossentropy",optimizer:e.optimizer||"sgd",metrics:["acc"]}),r=e.windowHopRatio||.25,n=this.collectTransferDataAsTensors(null,r),s=n.xs,i=n.ys,console.log("Training data: xs.shape = "+s.shape+", ys.shape = "+i.shape),a.label=1;case 1:return a.trys.push([1,,6,7]),null!=e.validationSplit?(c=function(e,r,n){return t.util.assert(n>0&&n<1,"validationSplit is expected to be >0 and <1, but got "+n),t.tidy(function(){for(var a=r.argMax(-1).dataSync(),s=[],i=0;i<a.length;++i){var o=a[i];null==s[o]&&(s[o]=[]),s[o].push(i)}var l=s.length,u=[],c=[];for(s.map(function(e){return t.util.shuffle(e)}),i=0;i<l;++i)for(var h=s[i],d=Math.round(h.length*(1-n)),p=0;p<h.length;++p)p<d?u.push(h[p]):c.push(h[p]);return{trainXs:t.gather(e,u),trainYs:t.gather(r,u),valXs:t.gather(e,c),valYs:t.gather(r,c)}})}(s,i,e.validationSplit),o=c.trainXs,l=c.trainYs,u=[c.valXs,c.valYs]):(o=s,l=i),[4,this.model.fit(o,l,{epochs:null==e.epochs?20:e.epochs,validationData:u,batchSize:e.batchSize,callbacks:null==e.callback?null:[e.callback]})];case 2:return h=a.sent(),null!=e.fineTuningEpochs&&e.fineTuningEpochs>0?(d=this.secondLastBaseDenseLayer.trainable,this.secondLastBaseDenseLayer.trainable=!0,p=null==e.fineTuningOptimizer?"sgd":e.fineTuningOptimizer,this.model.compile({loss:"categoricalCrossentropy",optimizer:p,metrics:["acc"]}),[4,this.model.fit(o,l,{epochs:e.fineTuningEpochs,validationData:u,batchSize:e.batchSize,callbacks:null==e.fineTuningCallback?null:[e.fineTuningCallback]})]):[3,4];case 3:return f=a.sent(),this.secondLastBaseDenseLayer.trainable=d,[2,[h,f]];case 4:return[2,h];case 5:return[3,7];case 6:return t.dispose([s,i,o,l,u]),[7];case 7:return[2]}})})},i.prototype.evaluate=function(e){return n(this,void 0,void 0,function(){var r,n=this;return a(this,function(a){return t.util.assert(null!=e.wordProbThresholds&&e.wordProbThresholds.length>0,"Received null or empty wordProbThresholds"),r=0,t.util.assert("_background_noise_"===this.words[r],"Cannot perform evaluation when the first tag is not _background_noise_"),[2,t.tidy(function(){for(var a=[],s=0,i=n.collectTransferDataAsTensors(null,e.windowHopRatio),o=i.xs,l=i.ys.argMax(-1).dataSync(),u=n.model.predict(o),c=u.slice([0,1],[u.shape[0],u.shape[1]-1]).max(-1),h=u.shape[0],d=0;d<e.wordProbThresholds.length;++d){for(var p=e.wordProbThresholds[d],f=c.greater(t.scalar(p)).dataSync(),m=0,g=0,v=0,b=0,y=0;y<h;++y)l[y]===r?(m++,f[y]&&v++):(g++,f[y]&&b++);var w=v/m,x=b/g;a.push({probThreshold:p,fpr:w,tpr:x}),console.log("ROC thresh="+p+": fpr="+w.toFixed(4)+", tpr="+x.toFixed(4)),d>0&&(s+=Math.abs(a[d-1].fpr-a[d].fpr)*(a[d-1].tpr+a[d].tpr)/2)}return{rocCurve:a,auc:s}})]})})},i.prototype.createTransferModelFromBaseModel=function(){t.util.assert(null!=this.words,"No word example is available for tranfer-learning model of name "+this.name);for(var e=this.baseModel.layers,r=e.length-2;r>=0&&"dense"!==e[r].getClassName().toLowerCase();)r--;if(r<0)throw new Error("Cannot find a hidden dense layer in the base model.");this.secondLastBaseDenseLayer=e[r];var n=this.secondLastBaseDenseLayer.output;this.transferHead=t.sequential(),this.transferHead.add(t.layers.dense({units:this.words.length,activation:"softmax",inputShape:n.shape.slice(1)}));var a=this.transferHead.apply(n);this.model=t.model({inputs:this.baseModel.inputs,outputs:a})},i.prototype.modelInputShape=function(){return this.baseModel.inputs[0].shape},i.prototype.getMetadata=function(){return{tfjsSpeechCommandsVersion:E,modelName:this.name,timeStamp:(new Date).toISOString(),wordLabels:this.wordLabels()}},i.prototype.save=function(e){return n(this,void 0,void 0,function(){var t,r,n;return a(this,function(a){return t=null!=e,e=e||C(this.name),t||(r=z.localStorage.getItem(T),(n=null==r?{}:JSON.parse(r))[this.name]=this.getMetadata(),z.localStorage.setItem(T,JSON.stringify(n))),console.log("Saving model to "+e),[2,this.model.save(e)]})})},i.prototype.load=function(e){return n(this,void 0,void 0,function(){var r,n,s;return a(this,function(a){switch(a.label){case 0:if(r=null!=e,e=e||C(this.name),!r){if(null==(n=JSON.parse(z.localStorage.getItem(T)))||null==n[this.name])throw new Error("Cannot find metadata for transfer model named "+this.name+'"');this.words=n[this.name].wordLabels,console.log("Loaded word list for model named "+this.name+": "+this.words)}return s=this,[4,t.loadModel(e)];case 1:return s.model=a.sent(),console.log("Loaded model from "+e+":"),this.model.summary(),[2]}})})},i.prototype.createTransfer=function(e){throw new Error("Creating transfer-learned recognizer from a transfer-learned recognizer is not supported.")},i}(L);function C(e){return""+M+e}e.create=function(e,r,n,a){if(t.util.assert(null==n&&null==a||null!=n&&null!=a,"customModelURL and customMetadataURL must be both provided or both not provided."),null!=n&&t.util.assert(null==r,"vocabulary name must be null or undefined when modelURL is provided"),"BROWSER_FFT"===e)return new L(r,n,a);throw"SOFT_FFT"===e?new Error("SOFT_FFT SpeechCommandRecognizer has not been implemented yet."):new Error("Invalid fftType: '"+e+"'")},e.BACKGROUND_NOISE_TAG="_background_noise_",e.Dataset=v,e.getMaxIntensityFrameIndex=S,e.spectrogram2IntensityCurve=x,e.deleteSavedTransferModel=function(e){return n(this,void 0,void 0,function(){var r;return a(this,function(n){switch(n.label){case 0:return null==(r=JSON.parse(z.localStorage.getItem(T)))&&(r={}),null!=r[e]&&delete r[e],z.localStorage.setItem(T,JSON.stringify(r)),[4,t.io.removeModel(C(e))];case 1:return n.sent(),[2]}})})},e.listSavedTransferModels=function(){return n(this,void 0,void 0,function(){var e,r,n;return a(this,function(a){switch(a.label){case 0:return[4,t.io.listModels()];case 1:for(n in e=a.sent(),r=[],e)n.startsWith(M)&&r.push(n.slice(M.length));return[2,r]}})})},e.UNKNOWN_TAG="_unknown_",e.version=E,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=speech-commands.min.js.map
